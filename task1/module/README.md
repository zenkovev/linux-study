# Комментарии к модулю

## Использование

Для сборки модуля используется `Makefile`, он сделан независимым от локальной структуры
директорий, в частности, ему нужно передать переменную окружения `VROOT_PATH`.
Для локальных запусков я использовал скрипты `run.sh`, `clean.sh`, они уже зависимы от
путей. Также, внутри запущенного ядра я использовал скрипт `test.sh` как реализованный
пример работы модуля.

Установка модуля:
```shell
insmod phone_book.ko

dmesg
# в логах ядра ищем строку вида:
# [   12.288574] phone_book module loaded with device major number 248
# запоминаем отсюда major number
# при запусках он всегда был 248

mknod /dev/phone_book c 248 0
```

Удаление модуля:
```shell
rm /dev/phone_book
rmmod phone_book.ko
```

После полной установки модуля с ним можно работать, как с файлом:
```shell
echo "add <user_name> <user_age> <user_telephone> <user_email>" > /dev/phone_book
# добавление пользователя в телефонную книгу

cat /dev/phone_book | grep "^<user_name>$(printf '\t')"
# вывести информацию о данном пользователе

echo "del <user_name>" > /dev/phone_book
# удаление пользователя из телефонной книги
```

Демонстрация находится в файле `demonstration.mp4`.

## Реализация

Из документации самым полезным оказались комментарии в хедерах ядра:
- Типы ошибок: `linux-6.7.4/include/uapi/asm-generic/errno-base.h`
- Хеш-таблица в ядре: `linux-6.7.4/include/linux/hashtable.h`
- Лист для хеш-таблицы в ядре: `linux-6.7.4/include/linux/list.h`

При реализации на вывод всей телефонной книги я использовал `kmalloc` с возможными `kreallock`.
Экспериментально, `kreallock` не справлялся на размерах памяти порядка нескольких мегабайт,
полагаю, этого с запасом хватит на все наши нужды. Можно было переделать на `vmalloc`,
но я поленился.

Также, при решении я предполагал, что информацию о пользователе передают при одной записи
в символьное устройство целиком, ровно так происходит, если вызывать `echo` на не слишком
больших объёмах данных, понятно, что это не очень хорошо, но я не захотел лишний раз
возиться с байтами, идейно в рамках задания это не очень интересно, просто глина.
В противном случае модуль по крайней мере должен выжить, просто выдаст ошибку
_некорректный аргумент_.